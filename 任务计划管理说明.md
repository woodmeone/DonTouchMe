# DonTouchMe 任务计划管理说明

## 问题说明

如果你发现电脑**睡眠后唤醒没有触发监测**，原因是系统中还没有安装 Windows 任务计划程序。

DonTouchMe 需要通过 Windows 任务计划程序来实现：
- 开机自动触发监测
- 睡眠唤醒自动触发监测

---

## 解决方案：在 GUI 中安装任务计划

现在你可以直接在可视化界面中安装任务计划，无需手动运行脚本！

### 第一步：启动 GUI 应用

```bash
python gui.py
```

或者直接双击 `gui.py` 文件。

### 第二步：打开任务计划管理

1. 右键点击系统托盘中的 DonTouchMe 图标
2. 选择"**任务计划管理**"

### 第三步：查看状态

任务计划管理窗口会显示：
- 当前任务计划的安装状态
- 是否以管理员权限运行
- 任务计划的详细信息

### 第四步：安装任务计划

#### 如果当前**不是**管理员权限：

1. 点击"**安装任务计划**"按钮
2. 会弹出提示：是否要以管理员身份重新启动 GUI 应用
3. 点击"**是**"
4. 系统会以管理员权限重新打开 GUI（会有 UAC 权限提示）
5. 在新的 GUI 窗口中，再次打开"任务计划管理"
6. 点击"安装任务计划"，即可成功安装

#### 如果当前**已是**管理员权限：

1. 直接点击"**安装任务计划**"按钮
2. 确认安装
3. 等待安装完成
4. 显示"所有任务计划安装成功！"

---

## 安装后的任务

安装成功后，会创建两个任务计划：

### 1. DonTouchMe_Boot（开机任务）
- **触发时机**：系统启动时
- **延迟时间**：10 秒
- **功能**：开机后自动拍照、截图、发送通知

### 2. DonTouchMe_Wake（唤醒任务）
- **触发时机**：从睡眠/休眠唤醒时
- **延迟时间**：5 秒
- **功能**：唤醒后自动拍照、截图、发送通知

---

## 验证安装是否成功

### 方法 1：在任务计划管理窗口查看

1. 打开"任务计划管理"
2. 点击"刷新状态"
3. 应该显示：
   ```
   ✓ 所有任务计划已安装
     • DonTouchMe_Boot - 开机时自动运行
     • DonTouchMe_Wake - 从睡眠唤醒时自动运行
   ```

### 方法 2：在 Windows 任务计划程序中查看

1. 按 `Win + R`
2. 输入 `taskschd.msc`，回车
3. 在左侧找到"任务计划程序库"
4. 应该能看到 `DonTouchMe_Boot` 和 `DonTouchMe_Wake` 两个任务

### 方法 3：测试实际功能

#### 测试唤醒触发：
1. 让电脑进入睡眠模式（Win + X → 睡眠）
2. 唤醒电脑
3. 等待约 5 秒，应该会收到微信通知
4. 打开"历史记录"窗口，应该能看到类型为"唤醒"的记录

#### 测试开机触发：
1. 重启电脑
2. 等待约 10 秒，应该会收到微信通知
3. 打开"历史记录"窗口，应该能看到类型为"开机"的记录

---

## 卸载任务计划

如果将来需要卸载任务计划：

1. 打开"任务计划管理"
2. 点击"**卸载任务计划**"按钮
3. 确认卸载
4. 等待卸载完成

注意：卸载后将无法自动监控开机和唤醒事件，但手动触发功能仍然可用。

---

## 常见问题

### Q1: 为什么需要管理员权限？
A: Windows 任务计划程序的创建和修改需要管理员权限，这是 Windows 系统的安全限制。

### Q2: 安装后为什么没有触发？
A: 请检查：
   1. 任务计划是否真的安装成功（打开任务计划管理查看）
   2. 日志文件中是否有报错信息（`logs/dontouchme_YYYYMMDD.log`）
   3. 配置文件中的 PushPlus Token 是否正确

### Q3: 如何查看日志？
A: 日志文件位于 `logs/` 目录下，文件名格式为 `dontouchme_YYYYMMDD.log`。

### Q4: 任务计划会在后台运行吗？
A: 任务计划本身不会常驻后台，只有在触发条件满足时（开机或唤醒）才会执行。GUI 托盘应用是独立的，可以随时关闭。

### Q5: 我可以只安装其中一个任务吗？
A: 目前暂不支持选择性安装，但你可以：
   1. 安装全部任务
   2. 然后在 Windows 任务计划程序中手动禁用不需要的任务

---

## 技术说明

### 任务计划的实现原理

- **开机任务**：使用 `ONSTART` 触发器，系统启动时自动运行
- **唤醒任务**：使用事件触发器，监听 `Microsoft-Windows-Power-Troubleshooter` 的事件 ID 1（系统从任何状态恢复）

### 为什么使用 pythonw.exe？

任务计划使用 `pythonw.exe` 而不是 `python.exe`，这样执行时不会弹出控制台窗口，用户体验更好。

---

## 更新说明

本功能在 Stage 4.5 中添加，解决了睡眠唤醒不触发监测的问题。

之前需要手动以管理员身份运行 `scripts/install_task.py`，现在可以直接在 GUI 中一键安装！
