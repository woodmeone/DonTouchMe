# DonTouchMe 安装包创建指南

本指南将帮助您使用 Inno Setup 创建专业的 Windows 安装程序。

## 📋 准备工作

### 1. 下载并安装 Inno Setup

**下载地址**: https://jrsoftware.org/isdl.php

选择以下任一版本：
- **Inno Setup 6.x** (推荐，最新稳定版)
- 下载 `innosetup-6.x.x.exe` (约 2-3 MB)

**安装步骤**:
1. 双击下载的 `innosetup-6.x.x.exe`
2. 按提示完成安装
3. 默认安装路径: `C:\Program Files (x86)\Inno Setup 6\`

### 2. 确保已打包 PyInstaller 程序

确保 `dist/DonTouchMe/` 文件夹存在且包含：
```
dist/DonTouchMe/
├── DonTouchMe.exe
└── _internal/
```

如果没有，先运行：
```bash
python -m PyInstaller DonTouchMe.spec --clean
```

---

## 🚀 创建安装包

### 方法 1: 使用图形界面（推荐新手）

1. **启动 Inno Setup**
   - 开始菜单 → Inno Setup → Inno Setup Compiler

2. **打开脚本文件**
   - File → Open → 选择 `installer.iss`

3. **编译生成安装程序**
   - Build → Compile (或按 F9)
   - 等待编译完成（约 10-30 秒）

4. **查看生成的安装程序**
   - 安装包位于: `installer_output/DonTouchMe_Setup_v1.0.0.exe`

### 方法 2: 使用命令行（推荐自动化）

```bash
# 确保 Inno Setup 安装路径在环境变量中
"C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
```

或创建批处理文件 `build_installer.bat`:
```batch
@echo off
echo ========================================
echo DonTouchMe 安装包生成工具
echo ========================================
echo.

echo [1/3] 检查 Inno Setup...
if not exist "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" (
    echo 错误: 未找到 Inno Setup!
    echo 请从 https://jrsoftware.org/isdl.php 下载并安装
    pause
    exit /b 1
)

echo [2/3] 检查程序文件...
if not exist "dist\DonTouchMe\DonTouchMe.exe" (
    echo 错误: 未找到可执行文件!
    echo 请先运行: python -m PyInstaller DonTouchMe.spec --clean
    pause
    exit /b 1
)

echo [3/3] 生成安装程序...
"C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss

if %errorlevel% == 0 (
    echo.
    echo ========================================
    echo 安装包生成成功！
    echo 位置: installer_output\DonTouchMe_Setup_v1.0.0.exe
    echo ========================================
    start explorer installer_output
) else (
    echo.
    echo ========================================
    echo 生成失败，请检查错误信息
    echo ========================================
)

pause
```

---

## 📦 生成的安装包功能

### 安装程序特性

- ✅ **现代化界面**: Windows 11 风格界面
- ✅ **中文界面**: 完整的简体中文支持
- ✅ **自定义安装路径**: 用户可选择安装位置
- ✅ **可选组件**:
  - 创建桌面快捷方式
  - 开机自动启动
- ✅ **智能检测**:
  - 检查 Windows 版本（需要 Win10+）
  - 检测程序是否正在运行
- ✅ **完整卸载**:
  - 卸载程序文件
  - 可选保留配置和历史记录
- ✅ **安装后提示**: 首次安装提示配置 Token

### 安装包包含内容

```
安装后的文件结构:
C:\Program Files\DonTouchMe\
├── DonTouchMe.exe         # 主程序
├── _internal\             # 依赖库
├── data\                  # 数据目录
│   ├── config.json        # 配置文件
│   └── captures\          # 照片目录
├── logs\                  # 日志目录
├── 使用说明-可执行文件.md
├── README.md
└── unins000.exe          # 卸载程序
```

### 开始菜单快捷方式

安装后会在开始菜单创建文件夹，包含：
- DonTouchMe（启动程序）
- 配置文件（打开 config.json）
- 查看日志（打开 logs 文件夹）
- 使用说明（打开文档）
- 卸载 DonTouchMe

---

## 🎨 自定义安装包

### 修改版本号

编辑 `installer.iss` 文件顶部：
```pascal
#define MyAppVersion "1.0.0"  // 修改这里
```

### 添加图标

1. 准备一个 `.ico` 图标文件（256x256 推荐）
2. 将图标文件放在项目根目录，命名为 `icon.ico`
3. 取消注释 `installer.iss` 中的这一行：
```pascal
SetupIconFile=icon.ico
```

### 添加许可证

1. 创建 `LICENSE.txt` 文件
2. 取消注释：
```pascal
LicenseFile=LICENSE.txt
```

### 修改发布者信息

```pascal
#define MyAppPublisher "您的名字或公司"
#define MyAppURL "您的网站"
```

---

## 📊 安装包大小

| 组件 | 大小 |
|------|------|
| 原始文件 | ~150 MB |
| 安装包 (压缩后) | ~50-60 MB |
| 安装后 | ~150 MB |

---

## 🧪 测试安装包

### 测试步骤

1. **生成安装包**
   ```bash
   build_installer.bat
   ```

2. **双击运行安装程序**
   ```
   installer_output\DonTouchMe_Setup_v1.0.0.exe
   ```

3. **测试安装流程**
   - ✅ 检查欢迎界面
   - ✅ 选择安装路径
   - ✅ 选择可选组件（桌面图标、开机启动）
   - ✅ 确认安装
   - ✅ 等待安装完成
   - ✅ 启动程序

4. **测试程序功能**
   - ✅ 系统托盘图标显示
   - ✅ 配置 PushPlus Token
   - ✅ 手动触发测试
   - ✅ 查看历史记录

5. **测试卸载**
   - 控制面板 → 程序和功能 → 卸载 DonTouchMe
   - 或：开始菜单 → DonTouchMe → 卸载
   - ✅ 确认卸载
   - ✅ 选择是否删除配置文件
   - ✅ 验证文件已删除

---

## 🚢 分发安装包

### 方式 1: 直接分享

将 `DonTouchMe_Setup_v1.0.0.exe` 发送给用户，双击安装即可。

### 方式 2: 上传到 GitHub Releases

```bash
# 1. 创建 Git Tag
git tag v1.0.0
git push origin v1.0.0

# 2. 在 GitHub 仓库创建 Release
# - 前往 GitHub 仓库
# - Releases → Create a new release
# - 选择 tag v1.0.0
# - 上传 DonTouchMe_Setup_v1.0.0.exe
# - 填写更新说明
# - Publish release
```

### 方式 3: 上传到网盘

- 上传到百度网盘、阿里云盘等
- 分享链接给用户

### 方式 4: 创建官网下载

- 放在自己的网站服务器
- 提供直接下载链接

---

## 🔒 代码签名（可选）

为了避免 Windows Defender 警告，建议进行代码签名：

1. **获取代码签名证书**
   - 从 DigiCert、Sectigo 等机构购买
   - 价格约 $50-200/年

2. **签名工具**
   - 使用 Windows SDK 的 `signtool.exe`

3. **签名命令**
   ```bash
   signtool sign /f certificate.pfx /p password /t http://timestamp.digicert.com installer_output\DonTouchMe_Setup_v1.0.0.exe
   ```

4. **验证签名**
   - 右键安装包 → 属性 → 数字签名

---

## 📝 发布检查清单

发布前确认：

- [ ] 版本号正确
- [ ] 程序功能完整测试
- [ ] 安装流程测试通过
- [ ] 卸载流程测试通过
- [ ] README 和文档更新
- [ ] 更新日志编写完成
- [ ] （可选）代码签名完成
- [ ] GitHub Release 准备

---

## ❓ 常见问题

### Q1: 编译时提示找不到文件
**A**: 确保 `dist/DonTouchMe/` 文件夹存在且完整

### Q2: 安装时提示需要管理员权限
**A**: 这是正常的，因为默认安装到 Program Files

### Q3: 如何修改默认安装路径
**A**: 编辑 `installer.iss`:
```pascal
DefaultDirName={localappdata}\{#MyAppName}  // 改为用户目录
```

### Q4: 安装包太大
**A**:
- 已经使用了最大压缩（lzma2/max）
- 主要大小来自 Python 运行时和依赖库
- 可以使用单文件打包减少文件数量

### Q5: Windows Defender 报警
**A**:
- 这是正常的，因为程序未签名
- 解决方法：购买代码签名证书
- 临时方法：告诉用户添加信任

---

## 🎯 快速开始

最简单的使用方式：

1. **确保已打包程序**
   ```bash
   python -m PyInstaller DonTouchMe.spec --clean
   ```

2. **运行批处理文件**
   ```bash
   build_installer.bat
   ```

3. **完成！**
   - 安装包位于: `installer_output\DonTouchMe_Setup_v1.0.0.exe`
   - 发送给用户即可

---

## 📞 技术支持

- **Inno Setup 官方文档**: https://jrsoftware.org/ishelp/
- **中文教程**: 搜索 "Inno Setup 教程"
- **GitHub Issues**: 遇到问题请提交 Issue

祝您打包顺利！🚀
