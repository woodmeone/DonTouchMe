# DonTouchMe 打包说明

## 如何重新打包程序

如果您修改了代码并需要重新生成可执行文件，请按照以下步骤操作：

### 前置要求

确保已安装 PyInstaller：
```bash
pip install pyinstaller
```

### 打包步骤

#### 方法 1: 使用配置文件（推荐）
```bash
python -m PyInstaller DonTouchMe.spec --clean
```

#### 方法 2: 使用命令行参数
```bash
pyinstaller --name=DonTouchMe ^
    --windowed ^
    --onedir ^
    --add-data "data/config.json;data" ^
    --add-data "src;src" ^
    --hidden-import cv2 ^
    --hidden-import mss ^
    --hidden-import PIL ^
    --hidden-import requests ^
    --hidden-import PyQt5 ^
    --hidden-import win32gui ^
    --hidden-import win32con ^
    --hidden-import win32api ^
    --hidden-import psutil ^
    gui.py
```

### 打包参数说明

- `--name=DonTouchMe`: 可执行文件名称
- `--windowed`: 不显示控制台窗口（GUI 程序）
- `--onedir`: 打包为文件夹形式（推荐，便于更新）
- `--add-data`: 添加数据文件
- `--hidden-import`: 显式导入可能被遗漏的模块
- `--clean`: 清理缓存，确保干净的构建

### 输出位置

打包完成后，文件将位于：
```
dist/DonTouchMe/
├── DonTouchMe.exe        # 主程序
└── _internal/            # 依赖库
```

### 单文件打包（可选）

如果想要生成单个 .exe 文件：
```bash
pyinstaller --name=DonTouchMe ^
    --windowed ^
    --onefile ^
    --add-data "data/config.json;data" ^
    --add-data "src;src" ^
    gui.py
```

**注意**: 单文件模式启动较慢，不推荐。

### 添加图标（可选）

1. 准备一个 `.ico` 图标文件（推荐 256x256）
2. 修改 `DonTouchMe.spec` 文件：
```python
exe = EXE(
    ...
    icon='path/to/your/icon.ico',  # 添加这一行
    ...
)
```
3. 重新打包

### 减小文件大小

1. **排除不需要的模块**:
   在 `DonTouchMe.spec` 的 `excludes` 中添加：
   ```python
   excludes=['tkinter', 'matplotlib', 'scipy'],
   ```

2. **使用 UPX 压缩** (已启用):
   - 下载 UPX: https://upx.github.io/
   - 将 UPX 添加到 PATH
   - PyInstaller 会自动使用 UPX 压缩

### 常见问题

#### 问题 1: 打包后运行报错 "找不到模块"
**解决**: 在 `DonTouchMe.spec` 的 `hiddenimports` 中添加缺失的模块

#### 问题 2: 打包文件过大
**解决**:
- 使用虚拟环境（只包含必需的依赖）
- 排除不需要的模块
- 使用 UPX 压缩

#### 问题 3: 运行时找不到配置文件
**解决**: 确保 `add-data` 参数正确添加了 `data` 和 `src` 目录

#### 问题 4: 打包后摄像头或截图功能失效
**解决**: 确保 OpenCV 的 DLL 文件被正确打包（已在 spec 文件中配置）

### 测试打包结果

打包完成后，运行测试：
```bash
python test_exe.py
```

或手动测试：
1. 双击 `dist/DonTouchMe/DonTouchMe.exe`
2. 查看系统托盘图标
3. 测试所有功能

### 发布清单

发布前检查：
- ✅ 程序可以正常启动
- ✅ 摄像头功能正常
- ✅ 截图功能正常
- ✅ 通知发送正常
- ✅ 配置文件读写正常
- ✅ 历史记录功能正常
- ✅ 系统托盘菜单正常
- ✅ 开机自动启动正常
- ✅ 后台监控功能正常

### 版本管理建议

每次发布新版本时：
1. 更新版本号（在代码中添加 `__version__` 变量）
2. 记录更新日志
3. 创建 Git Tag: `git tag v1.0.0`
4. 压缩 `dist/DonTouchMe` 为 ZIP 文件
5. 上传到 GitHub Releases

### 自动化打包脚本

创建 `build.bat`：
```batch
@echo off
echo 正在清理旧的构建文件...
rmdir /s /q build dist

echo 正在打包程序...
python -m PyInstaller DonTouchMe.spec --clean

echo 打包完成！
echo 可执行文件位于: dist\DonTouchMe\DonTouchMe.exe
pause
```

### 文件大小参考

- 可执行文件: ~5.8 MB
- 完整文件夹: ~150 MB
- 压缩后 (ZIP): ~50-60 MB

---

## 快速重新打包

如果您只是修改了代码，快速重新打包：
```bash
python -m PyInstaller DonTouchMe.spec --clean
```

就这么简单！✨
